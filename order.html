<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>訂單確認 | JieJourneys</title>
  <style>
    :root {
      --bg: #f9fafb;
      --card: #ffffff;
      --ink: #111827;
      --muted: #6b7280;
      --brand: #2563eb;
      --brand-hover: #1d4ed8;
      --ok: #059669;
      --warn: #dc2626;
      --radius: 18px;
      --shadow: 0 8px 24px rgba(0,0,0,0.06);
      --ring: 0 0 0 4px rgba(37,99,235,.15);
    }
    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg); font-family: "Noto Sans TC", system-ui, -apple-system, Arial; color: var(--ink); line-height: 1.5; }
    .wrap { max-width: 720px; margin: 40px auto; padding: 0 20px; }
    .card { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 28px 28px 32px; animation: fadeIn .4s ease; }
    h1 { margin: 0 0 8px; font-size: 30px; font-weight: 800; color: var(--ink); }
    .sub { color: var(--muted); margin-bottom: 20px; font-size: 15px; }

    .summary { display: flex; justify-content: space-between; align-items: center; background: #f3f4f6; border-radius: 12px; padding: 16px 18px; margin: 16px 0 20px; }
    .summary .name { font-weight: 700; font-size: 17px; }
    .summary .help { color: var(--muted); font-size: 14px; margin-top: 2px; }
    .price { font-weight: 800; font-size: 18px; color: var(--brand); }

    .field { margin-top: 18px; }
    label { display:block; font-weight: 600; margin-bottom: 6px; }
    input[type="text"], input[type="email"], textarea {
      width: 100%; padding: 12px 14px;
      border: 1px solid #d1d5db; border-radius: 12px; font-size: 16px; background: #fff;
      transition: border .15s, box-shadow .15s;
    }
    textarea { min-height: 100px; resize: vertical; }
    input[type="text"]:focus, input[type="email"]:focus, textarea:focus { outline: none; border-color: var(--brand); box-shadow: var(--ring); }

    /* 兩欄平均 */
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

    .policy { background:#f3f4f6; border-radius:12px; padding:16px; margin-top:18px; }
    .policy h3 { margin:0 0 6px; font-size:15px; font-weight:700; }
    .policy .text { color:#6b7280; font-size:14px; line-height:1.6; }
    input[type="checkbox"]{ width:auto; height:18px; margin:0; accent-color: var(--brand); }
    .agree{ display:grid; grid-template-columns: 20px 1fr; align-items:center; gap:10px; margin-top:5px; font-size:16px; color:#374151; }
    .agree label{ margin:0; }
    .agree a{ color:var(--brand); text-decoration:underline; }

    .actions { margin-top: 24px; display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
    .btn { background: var(--brand); color: #fff; border: 0; border-radius: 14px; padding: 13px 20px; font-weight: 700; font-size: 16px; cursor: pointer; transition: background .2s, transform .1s; }
    .btn:hover { background: var(--brand-hover); transform: translateY(-1px); }
    .btn:disabled { background: #9ca3af; cursor: not-allowed; }
    .ghost { background: #fff; color: #374151; border: 1px solid #d1d5db; }
    .ghost:hover { background: #f9fafb; }

    .note { margin-top: 10px; font-size: 14px; }
    .ok { color: var(--ok); }
    .err { color: var(--warn); }

    .spin { width:16px;height:16px; border:2px solid #fff;border-left-color:transparent; border-radius:50%;display:inline-block; vertical-align:-3px;animation:spin 1s linear infinite; margin-right:8px }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity:0; transform:translateY(6px);} to {opacity:1; transform:none;} }
    @media(max-width:640px){ .row{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>訂單確認</h1>
      <div class="sub">請確認商品與填寫收件 Email，付款完成後 3 分鐘內寄送 PDF。</div>

      <div class="summary">
        <div>
          <div class="name">釜山 5 日行程攻略 PDF</div>
        </div>
        <div class="price">NT$ 199</div>
      </div>

      <form id="orderForm" novalidate>
        <div class="row">
          <div class="field">
            <label>Email</label>
            <input id="email" type="email" placeholder="you@gmail.com" required />
            <div class="help">用來收取 PDF（請填寫可收信的 Email）</div>
          </div>
          <div class="field">
            <label>姓名</label>
            <input id="name" type="text" placeholder="王小明" />
          </div>
        </div>

        <div class="policy">
          <div class="agree">
            <input id="agree" type="checkbox" />
            <label for="agree">我同意本檔僅供個人使用，含浮水印與隱碼，嚴禁轉傳或販售。</label>
          </div>
        </div>

        <div class="actions">
          <button id="payBtn" class="btn" type="submit">前往付款</button>
          <a class="btn ghost" href="index.html">返回</a>
          <span id="msg" class="note"></span>
        </div>
      </form>
    </div>
  </div>

  <script>
    const form  = document.getElementById('orderForm');
    const payBtn = document.getElementById('payBtn');
    const msg   = document.getElementById('msg');
  
    // 你的 Supabase Edge Function 端點（注意有 /functions/v1/）
    const FUNCTION_URL = "https://fqhjwakhdizopjnindni.functions.supabase.co/functions/v1/pay";
    const ANON_KEY     = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZxaGp3YWtoZGl6b3Bqbm5pZG5pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MzcyNzAsImV4cCI6MjA3MTAxMzI3MH0.opToqcaOlh1UVdpXf4Gh9zjl8vWgkr35RPsYHkkaItY"; // Supabase 專案的 anon key
  
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.textContent = '';
      msg.className = 'note';
  
      const email = (document.getElementById('email').value || '').trim();
      const name  = (document.getElementById('name').value  || '').trim();
      const agree = document.getElementById('agree').checked;
  
      if (!email) { msg.textContent = '請輸入 Email。'; msg.className = 'note err'; return; }
      if (!/.+@.+\..+/.test(email)) { msg.textContent = 'Email 格式不正確。'; msg.className = 'note err'; return; }
      if (!agree) { msg.textContent = '請勾選同意條款。'; msg.className = 'note err'; return; }
  
      // UI loading
      payBtn.disabled = true;
      const oldHTML = payBtn.innerHTML;
      payBtn.innerHTML = '<span class="spin"></span>建立付款連結…';
  
      try {
        const res = await fetch(FUNCTION_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${ANON_KEY}`, // 很重要：Edge Function 要用 Bearer ANON_KEY
          },
          body: JSON.stringify({
            email,
            name,
            // 你可以把訂單資訊帶給後端（視你的 function 需求）
            productId: 'busan-5d',
            amount: 19900, // 單位分（若你的後端需要）
            returnUrl: 'https://busantrip.vercel.app/paid.html'
            // notifyUrl 不用從前端傳，已在藍新後台指定為 Supabase 的 newebpay-notify
          }),
        });
  
        if (!res.ok) {
          const t = await res.text();
          console.error('pay error:', res.status, t);
          throw new Error('Edge Function 回應非 2xx');
        }
  
        const data = await res.json();
        const payUrl = data.url || data.pay_url || data.PayUrl; // 兼容不同欄位命名
  
        if (payUrl) {
          window.location.href = payUrl; // 這一步才會真正跳去 Newebpay
        } else {
          console.error('no pay url in response:', data);
          msg.textContent = '建立付款連結失敗（缺少網址）。';
          msg.className = 'note err';
        }
      } catch (err) {
        console.error(err);
        msg.textContent = '伺服器錯誤，請稍後再試。';
        msg.className = 'note err';
      } finally {
        payBtn.disabled = false;
        payBtn.innerHTML = oldHTML;
      }
    });
  </script>
  
</body>
</html>
